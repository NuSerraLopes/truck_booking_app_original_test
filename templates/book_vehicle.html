{% extends 'base.html' %}
{% load i18n %}
{% load crispy_forms_tags %}

{% block title %}{% translate "Book Vehicle" %}{% endblock %}

{% block content %}
<link rel="stylesheet" href="/static/css/flatpickr.min.css">

<div class="container my-4">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-7">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h1 class="card-title text-center mb-4">{% translate "Book" %} {{ vehicle.model }} ({{ vehicle.license_plate }})</h1>

                    <div id="date-validation-error" class="alert alert-danger" style="display: none;"></div>
                    <div id="crc-lookup-message" class="alert" style="display: none;"></div>
                    <div id="vat-lookup-message" class="alert" style="display: none;"></div>

                    {% crispy form %}
                </div>
            </div>
        </div>
    </div>
</div>

<script src="/static/js/flatpickr.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- FORM ELEMENTS ---
    const crcInput = document.getElementById('id_client_company_registration');
    const companyNameInput = document.getElementById('id_customer_name');
    const nifInput = document.getElementById('id_client_tax_number');
    const addressInput = document.getElementById('id_customer_address');
    const startDateInput = document.getElementById('id_start_date');
    const endDateInput = document.getElementById('id_end_date');
    const phoneNumberInput = document.getElementById('id_customer_phone');
    const emailInput = document.getElementById('id_customer_email');
    const startLocationInput = document.getElementById('id_start_location');
    const endLocationInput = document.getElementById('id_end_location');
    const contractInput = document.getElementById('id_contract_document');
    const motiveInput = document.getElementById('id_motive');
    const submitButton = document.querySelector('input[type="submit"]');
    const dateErrorDiv = document.getElementById('date-validation-error');
    const crcMessageDiv = document.getElementById('crc-lookup-message');
    const vatMessageDiv = document.getElementById('vat-lookup-message');

    // --- GET SETTING FROM DJANGO ---
    const crcIsMandatory = {{ crc_is_mandatory|yesno:"true,false" }};

    // --- STATE MANAGEMENT ---
    let isCrcVerified = false;
    let isVatVerified = false;

    // --- HELPER FUNCTIONS ---
    const identityFields = [companyNameInput, addressInput];
    const contactFields = [phoneNumberInput, emailInput];
    const bookingFields = [startDateInput, endDateInput, startLocationInput, endLocationInput, contractInput, motiveInput];

    function toggleFields(fields, enable) {
        fields.forEach(field => {
            if (field) {
                field.disabled = !enable;
            }
        });
    }

    function toggleContactFields(enable) {
        toggleFields(contactFields, enable);
    }

    function toggleBookingFields(enable) {
        toggleFields(bookingFields, enable);
        if (!enable) {
            fpStart.clear();
            fpEnd.clear();
            endDateInput.disabled = true;
        }
    }

    function setFieldsReadOnly(fields, isReadOnly) {
        fields.forEach(field => {
            if (field) {
                field.readOnly = isReadOnly;
            }
        });
    }

    function validateFormState() {
        let datesAreValid = false;
        const start = startDateInput.value;
        const end = endDateInput.value;

        if (start && end) {
            const startDate = new Date(start + 'T00:00:00');
            const endDate = new Date(end + 'T00:00:00');
            if (startDate <= endDate) {
                datesAreValid = true;
                dateErrorDiv.style.display = 'none';
            } else {
                dateErrorDiv.textContent = "{% translate 'The end date must be on or after the start date.' %}";
                dateErrorDiv.style.display = 'block';
            }
        } else {
            datesAreValid = false;
        }

        if (submitButton) {
            submitButton.disabled = !(datesAreValid && (isCrcVerified || isVatVerified));
        }
    }

    // --- FLATICKR DATE PICKER LOGIC ---
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    const unavailableRanges = JSON.parse('{{ unavailable_ranges_json|default:"[]"|safe }}');
    const disabledDates = unavailableRanges.map(range => ({ from: range.start, to: range.end }));

    const fpEnd = flatpickr(endDateInput, {
        dateFormat: "Y-m-d",
        minDate: tomorrow,
        disable: disabledDates,
        onChange: function() {
            validateFormState();
        }
    });

    const fpStart = flatpickr(startDateInput, {
        dateFormat: "Y-m-d",
        minDate: tomorrow,
        disable: disabledDates,
        onChange: function(selectedDates) {
            if (selectedDates[0]) {
                fpEnd.set('minDate', selectedDates[0]);
                endDateInput.disabled = false;
            }
            validateFormState();
        }
    });

    // --- DYNAMIC COUNTRY SELECTOR ---
    const nifWrapperDiv = document.getElementById('div_id_client_tax_number');
    if (nifInput && nifWrapperDiv) {
        const countrySelect = document.createElement('select');
        countrySelect.id = 'id_country_code';
        countrySelect.className = 'form-select';
        countrySelect.style.flex = '0 0 100px';

        const flagImage = document.createElement('img');
        flagImage.className = 'input-group-text';
        flagImage.style.padding = '0.375rem'; // Use standard bootstrap padding
        flagImage.style.height = 'auto';
        flagImage.alt = 'Selected country flag';

        const inputGroupWrapper = document.createElement('div');
        inputGroupWrapper.className = 'input-group';

        // Move the original nifInput into the new wrapper
        nifInput.parentElement.replaceChild(inputGroupWrapper, nifInput);
        inputGroupWrapper.appendChild(flagImage);
        inputGroupWrapper.appendChild(countrySelect);
        inputGroupWrapper.appendChild(nifInput);

        const verifyNifButtonContainer = document.createElement('div');
        verifyNifButtonContainer.className = 'text-end mt-2';
        const verifyNifButton = document.createElement('button');
        verifyNifButton.type = 'button';
        verifyNifButton.className = 'btn btn-info btn-sm';
        verifyNifButton.textContent = '{% translate "Verify VAT" %}';
        verifyNifButtonContainer.appendChild(verifyNifButton);
        nifWrapperDiv.appendChild(verifyNifButtonContainer);

        function updateFlag(countryCode) {
            let flagCode = countryCode.toLowerCase();
            if (flagCode === 'el') {
                flagCode = 'gr';
            } else if (flagCode === 'xi') {
                flagCode = 'gb';
            }
            flagImage.src = `https://flagcdn.com/w40/${flagCode}.png`;
        }

        fetch("{% url 'booking_app:get_vies_countries' %}")
            .then(response => response.json())
            .then(countries => {
                countries.forEach(country => {
                    const option = document.createElement('option');
                    option.value = country.countryCode;
                    option.textContent = country.countryCode;
                    if (country.countryCode === 'PT') {
                        option.selected = true;
                    }
                    countrySelect.appendChild(option);
                });
                updateFlag(countrySelect.value);
            });

        countrySelect.addEventListener('change', function() {
            updateFlag(this.value);
            if (nifInput.value) {
                verifyVat(nifInput.value);
            }
            nifInput.value = '';
            nifInput.dispatchEvent(new Event('input'));
        });

        verifyNifButton.addEventListener('click', function() {
            if (nifInput.value) {
                verifyVat(nifInput.value);
            } else {
                alert('{% translate "Please enter a VAT number first." %}');
            }
        });
    }


    // --- VAT/NIF VALIDATION LOGIC ---
    nifInput.addEventListener('input', function(e) {
        let value = e.target.value.replace(/[^a-zA-Z0-9]/g, '');
        e.target.value = value.toUpperCase();
        isVatVerified = false;
        vatMessageDiv.style.display = 'none';
        companyNameInput.value = '';
        addressInput.value = '';
        validateFormState();
    });

    function verifyVat(vatNumber) {
        const countryCode = document.getElementById('id_country_code').value;
        vatMessageDiv.className = 'alert alert-info';
        vatMessageDiv.textContent = '{% translate "Verifying VAT number..." %}';
        vatMessageDiv.style.display = 'block';

        fetch(`{% url 'booking_app:validate_vat' %}?country_code=${countryCode}&vat_number=${vatNumber}`)
            .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
            .then(data => {
                var companyName;
                if (data.valid) {
                    if (data.company_name === "---") {
                        vatMessageDiv.className = 'alert alert-success';
                        vatMessageDiv.textContent = '{% translate "VAT number is valid. But no company name provided" %}';
                        setFieldsReadOnly(identityFields, false);
                        toggleFields(identityFields, true);
                        toggleContactFields(true);
                        toggleBookingFields(true);
                    } else {
                        vatMessageDiv.className = 'alert alert-success';
                        vatMessageDiv.textContent = `{% translate "VAT number is valid." %} ${data.company_name || ''}`;
                        isVatVerified = true;
                        if (!companyNameInput.value) companyNameInput.value = data.company_name || '';
                        if (!addressInput.value) addressInput.value = (data.address || '').replace(/\\n/g, ', ').replace(/---/g, '').trim();
                        toggleContactFields(true);
                        toggleBookingFields(true);
                        setFieldsReadOnly(identityFields, true);
                    }
                } else {
                    vatMessageDiv.className = 'alert alert-danger';
                    vatMessageDiv.textContent = data.error || '{% translate "Invalid VAT number." %}';
                    isVatVerified = false;
                }
            })
            .catch(error => {
                console.error("VAT fetch failed:", error);
                vatMessageDiv.className = 'alert alert-danger';
                vatMessageDiv.textContent = '{% translate "An error occurred during VAT verification." %}';
                isVatVerified = false;
            })
            .finally(() => {
                validateFormState();
            });
    }

    // --- CRC COMPANY LOOKUP LOGIC ---
    const crcWrapperDiv = document.getElementById('div_id_client_company_registration');
    if (crcInput && crcWrapperDiv) {
        const verifyCrcButtonContainer = document.createElement('div');
        verifyCrcButtonContainer.className = 'text-end mt-2';
        const verifyCrcButton = document.createElement('button');
        verifyCrcButton.textContent = '{% translate "Verify CRC" %}';
        verifyCrcButton.type = 'button';
        verifyCrcButton.className = 'btn btn-sm btn-info';
        verifyCrcButtonContainer.appendChild(verifyCrcButton);
        crcWrapperDiv.appendChild(verifyCrcButtonContainer);

        verifyCrcButton.addEventListener('click', function() {
            const crcValue = crcInput.value.trim();
            if (!crcValue) {
                alert('{% translate "Please enter a Company Registration Code first." %}');
                return;
            }
            crcMessageDiv.className = 'alert alert-info';
            crcMessageDiv.textContent = '{% translate "Looking up company..." %}';
            crcMessageDiv.style.display = 'block';
            verifyCrcButton.disabled = true;
            isCrcVerified = false;
            validateFormState();
            fetch(`{% url 'booking_app:get_company_details' %}?crc=${encodeURIComponent(crcValue)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        crcMessageDiv.className = 'alert alert-danger';
                        crcMessageDiv.textContent = data.error;
                        isCrcVerified = false;
                        toggleContactFields(false);
                        toggleBookingFields(false);
                    } else {
                        crcMessageDiv.className = 'alert alert-success';
                        crcMessageDiv.textContent = `{% translate "Company found:" %} ${data.company_name}`;
                        if (!companyNameInput.value) companyNameInput.value = data.company_name;
                        if (!nifInput.value) nifInput.value = data.nif;
                        if (!addressInput.value) addressInput.value = data.address;
                        isCrcVerified = true;
                        toggleContactFields(true);
                        toggleBookingFields(true);
                        setFieldsReadOnly(identityFields, true);
                        if (data.nif) {
                            verifyVat(data.nif);
                        }
                    }
                })
                .catch(error => {
                    crcMessageDiv.className = 'alert alert-danger';
                    crcMessageDiv.textContent = '{% translate "An unexpected error occurred. Please try again." %}';
                    console.error('Fetch error:', error);
                    isCrcVerified = false;
                    toggleContactFields(false);
                    toggleBookingFields(false);
                })
                .finally(() => {
                    verifyCrcButton.disabled = false;
                    validateFormState();
                });
        });

        crcInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '').substring(0, 12);
            if (value.length > 8) {
                value = value.replace(/(\d{4})(\d{4})(\d{1,4})/, '$1-$2-$3');
            } else if (value.length > 4) {
                value = value.replace(/(\d{4})(\d{1,4})/, '$1-$2');
            }
            e.target.value = value;

            if (isCrcVerified) {
                isCrcVerified = false;
                toggleContactFields(false);
                toggleBookingFields(false);
                setFieldsReadOnly(identityFields, false);
                companyNameInput.value = '';
                nifInput.value = '';
                addressInput.value = '';
                crcMessageDiv.style.display = 'none';
                validateFormState();
            }
        });
    }

    // --- INITIAL STATE ---
    function initializeForm() {
        if (crcIsMandatory) {
            toggleContactFields(false);
            toggleBookingFields(false);
            setFieldsReadOnly([companyNameInput, addressInput], false);
        } else {
            toggleContactFields(true);
            toggleBookingFields(true);
            endDateInput.disabled = true;
        }
        validateFormState();
    }

    initializeForm();

    if (mainForm) {
        mainForm.addEventListener('submit', function() {
            // Before submitting, re-enable all fields so their values are sent
            toggleFields(fieldsToToggle, true);
        });
    }
});
</script>
{% endblock %}
