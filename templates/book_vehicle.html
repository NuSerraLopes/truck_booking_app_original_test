{% extends 'base.html' %}
{% load i18n static %}
{% load crispy_forms_tags %}

{% block title %}{% translate "Book Vehicle" %}{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/flatpickr.min.css' %}">

<div class="container my-4">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-7">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h1 class="card-title text-center mb-4">{% translate "Book" %} {{ vehicle.model }} ({{ vehicle.license_plate }})</h1>
                    <div id="vat-lookup-message" class="alert" style="display: none;"></div>
                    <div id="crc-lookup-message" class="alert" style="display: none;"></div>
                    <div id="date-validation-error" class="alert alert-danger" style="display: none;"></div>
                    {% crispy form %}
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="client-conflict-modal" tabindex="-1" aria-labelledby="clientModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="clientModalLabel">{% translate "Client Data Conflict" %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="client-modal-body">
                {% if conflict_data|length == 1 %}
                    {% with conflict=conflict_data.0 %}
                        <p>{% translate "The information you submitted conflicts with an existing client for this Tax Number." %}</p>
                        <h6>{% translate "Detected Changes:" %}</h6>
                        <ul class="list-group">
                        {% for field, values in conflict.changes.items %}
                            <li class="list-group-item">
                                <strong>{{ field|capfirst }}:</strong>
                                <span class="text-muted"><del>{{ values.old|default:'empty' }}</del></span> â†’
                                <span class="fw-bold text-success">{{ values.new }}</span>
                            </li>
                        {% endfor %}
                        </ul>
                        <p class="mt-4">{% translate "How would you like to proceed?" %}</p>
                    {% endwith %}
                {% else %}
                    <p>{% translate "Multiple clients exist with this Tax Number. Please choose an action below." %}</p>
                    <h6>{% translate "Existing Clients:" %}</h6>
                    {% for conflict in conflict_data %}
                    <div class="form-check border rounded p-3 mb-2">
                        <input class="form-check-input" type="radio" name="selected_client_id" id="client_{{ conflict.client.id }}" value="{{ conflict.client.id }}" {% if forloop.first %}checked{% endif %}>
                        <label class="form-check-label" for="client_{{ conflict.client.id }}">
                            <strong>{{ conflict.client.name }}</strong><br>
                            <small class="text-muted">{{ conflict.client.address|default:'No address' }} | {{ conflict.client.email|default:'' }} | {{ conflict.client.phone_number|default:'' }}</small>
                        </label>
                    </div>
                    {% endfor %}
                {% endif %}
            </div>
            <div class="modal-footer justify-content-between">
                <div>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% translate "Go Back" %}</button>
                </div>
                <div>
                    {% if conflict_data|length == 1 %}
                        <button type="button" class="btn btn-outline-secondary" onclick="resolveConflict('discard_changes', {{ conflict_data.0.client.id }})">{% translate "Discard My Changes" %}</button>
                        <button type="button" class="btn btn-primary" onclick="resolveConflict('update_existing', {{ conflict_data.0.client.id }})">{% translate "Update Existing Client" %}</button>
                    {% else %}
                        <button type="button" class="btn btn-outline-secondary" onclick="resolveConflict('discard_changes', null)">{% translate "Use Selected Client (No Changes)" %}</button>
                        <button type="button" class="btn btn-primary" onclick="resolveConflict('update_existing', null)">{% translate "Update Selected Client" %}</button>
                    {% endif %}
                     <button type="button" class="btn btn-info" onclick="resolveConflict('create_new', null)">{% translate "Create as New Client" %}</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}


{% block scripts %}
<script src="{% static 'js/flatpickr.min.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- FORM & MODAL ELEMENTS ---
    const mainForm = document.querySelector('form');
    const crcInput = document.getElementById('id_client_company_registration');
    const nameInput = document.getElementById('id_client_name');
    const nifInput = document.getElementById('id_client_tax_number');
    const addressInput = document.getElementById('id_client_address');
    const emailInput = document.getElementById('id_client_email');
    const phoneInput = document.getElementById('id_client_phone');
    const hiddenClientIdInput = document.getElementById('id_client_id');
    const hiddenResolutionInput = document.getElementById('id_conflict_resolution');
    const startDateInput = document.getElementById('id_start_date');
    const endDateInput = document.getElementById('id_end_date');
    const motiveInput = document.getElementById('id_motive');
    const submitButton = document.querySelector('input[type="submit"]');
    const dateErrorDiv = document.getElementById('date-validation-error');
    const crcMessageDiv = document.getElementById('crc-lookup-message');
    const vatMessageDiv = document.getElementById('vat-lookup-message');
    const clientModal = new bootstrap.Modal(document.getElementById('client-conflict-modal'));
    const clientModalLabel = document.getElementById('clientModalLabel');
    const clientModalBody = document.getElementById('client-modal-body');
    const clientModalFooter = document.getElementById('client-modal-footer');

    // --- SCRIPT TO OPEN MODAL IF A CONFLICT IS DETECTED ON SUBMIT ---
    {% if show_conflict_modal %}
        clientModal.show();
    {% endif %}

    // --- SCRIPT TO HANDLE USER'S CHOICE FROM THE MODAL ---
    window.resolveConflict = function(choice, clientId) {
        if (hiddenResolutionInput) {
            hiddenResolutionInput.value = choice;
        }

        if (clientId === null) {
            const selectedRadio = document.querySelector('input[name="selected_client_id"]:checked');
            if (selectedRadio) {
                clientId = selectedRadio.value;
            } else if (choice !== 'create_new') {
                alert('{% translate "Please select a client." %}');
                return;
            }
        }

        if (hiddenClientIdInput && clientId) {
            hiddenClientIdInput.value = clientId;
        }

        mainForm.submit();
    }

    // --- DYNAMIC COUNTRY SELECTOR & VAT BUTTON CREATION ---
    const nifWrapperDiv = document.getElementById('div_id_client_tax_number');
    if (nifInput && nifWrapperDiv) {
        const countrySelect = document.createElement('select');
        countrySelect.id = 'id_country_code';
        countrySelect.className = 'form-select';
        countrySelect.style.flex = '0 0 100px';
        const flagAddon = document.createElement('span');
        flagAddon.className = 'input-group-text p-1';
        const flagImage = document.createElement('img');
        flagImage.style.width = '28px';
        flagImage.alt = 'Selected country flag';
        flagAddon.appendChild(flagImage);
        const inputGroupWrapper = document.createElement('div');
        inputGroupWrapper.className = 'input-group';
        nifInput.parentElement.insertBefore(inputGroupWrapper, nifInput);
        inputGroupWrapper.appendChild(flagAddon);
        inputGroupWrapper.appendChild(countrySelect);
        inputGroupWrapper.appendChild(nifInput);

        const verifyNifButtonContainer = document.createElement('div');
        verifyNifButtonContainer.className = 'text-end mt-2';
        const verifyVatButton = document.createElement('button');
        verifyVatButton.type = 'button';
        verifyVatButton.className = 'btn btn-outline-secondary btn-sm';
        verifyVatButton.textContent = '{% translate "Pre-fill from DB / VIES" %}';
        verifyNifButtonContainer.appendChild(verifyVatButton);
        nifWrapperDiv.appendChild(verifyNifButtonContainer);

        function updateFlag(countryCode) {
            let flagCode = countryCode ? countryCode.toLowerCase() : '';
            if (flagCode === 'el') flagCode = 'gr';
            else if (flagCode === 'xi') flagCode = 'gb';
            flagImage.src = `https://flagcdn.com/w40/${flagCode}.png`;
        }

        fetch("{% url 'booking_app:get_vies_countries' %}")
            .then(response => response.json()).then(countries => {
                countries.forEach(country => {
                    const option = document.createElement('option');
                    option.value = country.countryCode;
                    option.textContent = country.countryCode;
                    if (country.countryCode === 'PT') option.selected = true;
                    countrySelect.appendChild(option);
                });
                updateFlag(countrySelect.value);
            });

        countrySelect.addEventListener('change', () => updateFlag(countrySelect.value));
        verifyVatButton.addEventListener('click', () => {
            const taxNumber = nifInput.value.trim();
            if (taxNumber) {
                fetch(`{% url 'booking_app:check_client_in_db' %}?tax_number=${taxNumber}`)
                    .then(response => {
                        if (response.ok) return response.json();
                        throw new Error('Client not in DB');
                    })
                    .then(data => {
                        if (data.clients && data.clients.length > 0) {
                            const client = data.clients[0];
                            nameInput.value = client.name || '';
                            addressInput.value = client.address || '';
                            emailInput.value = client.email || '';
                            phoneInput.value = client.phone_number || '';
                            vatMessageDiv.className = 'alert alert-info';
                            vatMessageDiv.textContent = `{% translate "Pre-filled data for existing client:" %} ${client.name}`;
                            vatMessageDiv.style.display = 'block';
                        }
                    })
                    .catch(() => {
                        const countryCode = countrySelect.value;
                        fetch(`{% url 'booking_app:validate_vat' %}?country_code=${countryCode}&vat_number=${taxNumber}`)
                            .then(response => response.json())
                            .then(data => {
                                if (data.valid) {
                                    nameInput.value = data.company_name || '';
                                    addressInput.value = (data.address || '').replace(/\\n/g, ', ').trim();
                                    vatMessageDiv.className = 'alert alert-success';
                                    vatMessageDiv.textContent = `{% translate "Pre-filled data from VIES." %}`;
                                    vatMessageDiv.style.display = 'block';
                                } else {
                                    vatMessageDiv.className = 'alert alert-warning';
                                    vatMessageDiv.textContent = data.error || '{% translate "Invalid VAT number." %}';
                                    vatMessageDiv.style.display = 'block';
                                }
                            });
                    });
            } else {
                alert('{% translate "Please enter a Tax Number first." %}');
            }
        });
    }

    // DYNAMIC BUTTON CREATION: CRC
    const crcWrapperDiv = document.getElementById('div_id_client_company_registration');
    if (crcInput && crcWrapperDiv) {
        const verifyCrcButtonContainer = document.createElement('div');
        verifyCrcButtonContainer.className = 'text-end mt-2';
        const verifyCrcButton = document.createElement('button');
        verifyCrcButton.textContent = '{% translate "Verify CRC" %}';
        verifyCrcButton.type = 'button';
        verifyCrcButton.className = 'btn btn-outline-secondary btn-sm';
        verifyCrcButtonContainer.appendChild(verifyCrcButton);
        crcWrapperDiv.appendChild(verifyCrcButtonContainer);

        verifyCrcButton.addEventListener('click', function() {
            const crcValue = crcInput.value.trim();
            if (!crcValue) {
                alert('{% translate "Please enter a Company Registration Code first." %}');
                return;
            }
            crcMessageDiv.className = 'alert alert-info';
            crcMessageDiv.textContent = '{% translate "Looking up company..." %}';
            crcMessageDiv.style.display = 'block';
            fetch(`{% url 'booking_app:get_company_details' %}?crc=${encodeURIComponent(crcValue)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                         crcMessageDiv.className = 'alert alert-danger';
                         crcMessageDiv.textContent = data.error;
                    } else {
                        crcMessageDiv.className = 'alert alert-success';
                        crcMessageDiv.textContent = `{% translate "Company found:" %} ${data.company_name}`;
                        if (nameInput && !nameInput.value) nameInput.value = data.company_name;
                        if (nifInput && !nifInput.value) nifInput.value = data.nif;
                        if (addressInput && !addressInput.value) addressInput.value = data.address;
                    }
                })
                .catch(error => console.error('CRC Fetch error:', error));
        });
    }

    // DATE PICKER LOGIC
    if (startDateInput && endDateInput) {
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        const unavailableRanges = JSON.parse('{{ unavailable_ranges_json|default:"[]"|safe }}');
        const disabledDates = [
            ...unavailableRanges.map(range => ({ from: range.start, to: range.end })),
            function(date) { return (date.getDay() === 0 || date.getDay() === 6); } // Disable weekends
        ];
        const fpEnd = flatpickr(endDateInput, { dateFormat: "Y-m-d", minDate: tomorrow, disable: disabledDates });
        const fpStart = flatpickr(startDateInput, {
            dateFormat: "Y-m-d", minDate: tomorrow, disable: disabledDates,
            onChange: function(selectedDates) {
                if (selectedDates[0]) {
                    fpEnd.set('minDate', new Date(selectedDates[0]));
                    endDateInput.disabled = false;
                }
            }
        });
    }
});
</script>
{% endblock scripts %}