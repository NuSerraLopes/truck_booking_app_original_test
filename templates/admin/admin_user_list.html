{% extends 'base.html' %}
{% load i18n %}
{% load static %}
{% load humanize %}  {% block title %}{{ page_title }}{% endblock %}

{% block content %}
<div class="container-fluid px-4 my-4">

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="h4 text-gray-800"><i class="bi bi-people-fill me-2"></i>{{ page_title }}</h2>

        <form method="get" class="d-flex align-items-center">
            <label class="me-2 text-nowrap text-muted small">{% translate "Show:" %}</label>
            <select name="per_page" class="form-select form-select-sm" onchange="this.form.submit()" style="width: auto;">
                <option value="10" {% if per_page == 10 %}selected{% endif %}>10</option>
                <option value="25" {% if per_page == 25 %}selected{% endif %}>25</option>
                <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
                <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
            </select>
        </form>
    </div>

    <div class="card shadow-sm">
        <form method="post" id="bulkActionForm">
            {% csrf_token %}

            <div class="card-header bg-light py-2 d-flex justify-content-between align-items-center">
                <div class="d-flex gap-2">
                    <button type="submit" name="action" value="send_credentials" class="btn btn-sm btn-primary"
                            onclick="return confirm('{% translate "Send welcome credentials to selected users?" %}')">
                        <i class="bi bi-envelope-plus me-1"></i> {% translate "Send Credentials" %}
                    </button>
                    <button type="submit" name="action" value="reset_password" class="btn btn-sm btn-outline-danger"
                            onclick="return confirm('{% translate "Reset passwords for selected users?" %}')">
                        <i class="bi bi-key me-1"></i> {% translate "Reset Passwords" %}
                    </button>
                </div>
                <div>
                    <a href="{% url 'booking_app:user_create' %}" class="btn btn-sm btn-success">
                        <i class="bi bi-person-plus"></i> {% translate "Add User" %}
                    </a>
                </div>
            </div>

            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover table-sm align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 40px;" class="text-center">
                                    <input type="checkbox" id="select-all" class="form-check-input">
                                </th>
                                <th>{% translate "Username" %}</th>
                                <th>{% translate "Email" %}</th>
                                <th>{% translate "Status" %}</th>
                                <th>{% translate "Sent?" %}</th>
                                <th>{% translate "Last Activity" %}</th>
                                <th class="text-end">{% translate "Actions" %}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in users %}
                            <tr>
                                <td class="text-center">
                                    <input type="checkbox" name="selected_users" value="{{ user.pk }}" class="form-check-input user-checkbox">
                                </td>
                                <td class="fw-bold">
                                    <a href="{% url 'booking_app:admin_user_edit' pk=user.pk %}" class="text-decoration-none text-dark">
                                        {{ user.username }}
                                    </a>
                                </td>
                                <td>{{ user.email|default:"-" }}</td>
                                <td>
                                    {% if user.is_logged_in %}
                                        <span class="badge bg-success rounded-pill">{% translate "Online" %}</span>
                                    {% else %}
                                        <span class="badge bg-secondary rounded-pill">{% translate "Offline" %}</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    {% if user.credentials_sent %}
                                        <i class="bi bi-check-circle-fill text-success" title="Credentials Sent"></i>
                                    {% else %}
                                        <i class="bi bi-circle text-muted" title="Not Sent"></i>
                                    {% endif %}
                                </td>
                                <td class="small text-muted">
                                    {% if user.last_activity %}
                                        {{ user.last_activity|naturaltime }}
                                    {% else %}
                                        {% translate "Never" %}
                                    {% endif %}
                                </td>
                                <td class="text-end">
                                    <div class="btn-group btn-group-sm">
                                        <a href="{% url 'booking_app:admin_user_edit' pk=user.pk %}" class="btn btn-outline-secondary" title="Edit">
                                            <i class="bi bi-pencil"></i>
                                        </a>
                                        <a href="{% url 'booking_app:user_deactivate' pk=user.pk %}" class="btn btn-outline-danger" title="Deactivate">
                                            <i class="bi bi-archive"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="7" class="text-center py-4 text-muted">
                                    {% translate "No users found." %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card-footer py-2">
                {% include "_pagination.html" with page_obj=users %}
            </div>
        </form>
    </div>
</div>

<script>
    document.getElementById('select-all').addEventListener('change', function(e) {
        const checkboxes = document.querySelectorAll('.user-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.checked = e.target.checked;
        });
    });
</script>
{% endblock %}