{% extends 'base.html' %}
{% load i18n %}
{% load static %}

{% block title %}{% translate "Manage Vehicles" %}{% endblock %}

{% block content %}
<div class="top-actions-bar">
    <h1 class="h3 mb-0">{% translate "Manage Vehicles" %}</h1>
    <div class="button-group">
        <a href="{% url 'booking_app:admin_vehicle_create' %}" class="btn btn-primary">
            {% translate "Add New Vehicle" %}
        </a>
        <a href="{% url 'booking_app:download_vehicle_template' %}" class="btn btn-secondary">
            {% translate "Download Template" %}
        </a>
        <button type="button" class="btn btn-info" data-bs-toggle="modal" data-bs-target="#importModal">
            {% translate "Import from CSV" %}
        </button>
    </div>
</div>

<div class="card shadow-sm">
    <div class="card-body">
        <form method="post" action="{% url 'booking_app:admin_vehicle_list' %}" class="mb-4">
            {% csrf_token %}
            <div class="row g-3 align-items-end">
                <div class="col-md-4">
                    <label for="filter_by" class="form-label">{% translate "Filter By" %}</label>
                    <select name="filter_by" id="filter_by" class="form-select">
                        <option value="">{% translate "All Text Fields (Plate, Model)" %}</option>
                        <option value="license_plate" {% if filter_by == 'license_plate' %}selected{% endif %}>{% translate "License Plate" %}</option>
                        <option value="model" {% if filter_by == 'model' %}selected{% endif %}>{% translate "Model" %}</option>
                        <option value="vehicle_type" {% if filter_by == 'vehicle_type' %}selected{% endif %}>{% translate "Type" %}</option>
                        <option value="annotated_is_available" {% if filter_by == 'annotated_is_available' %}selected{% endif %}>{% translate "Availability" %}</option>
                        <option value="current_customer" {% if filter_by == 'current_customer' %}selected{% endif %}>{% translate "Booked By (Customer)" %}</option>
                        <option value="current_location" {% if filter_by == 'current_location' %}selected{% endif %}>{% translate "Location" %}</option>
                        <option value="active_status" {% if filter_by == 'active_status' %}selected{% endif %}>{% translate "Active" %}</option>
                    </select>
                </div>

                <div class="col-md-5" id="filter-value-container">
                    <label for="filter_value" class="form-label">{% translate "Value" %}</label>

                    <input type="text" name="filter_value" id="text-input" class="form-control"
                           value="{{ filter_value|default:'' }}">

                    <select name="filter_value" id="type-input" class="form-select" style="display:none;">
                        <option value="HEAVY" {% if filter_value == 'HEAVY' %}selected{% endif %}>{% translate "Heavy" %}</option>
                        <option value="LIGHT" {% if filter_value == 'LIGHT' %}selected{% endif %}>{% translate "Light" %}</option>
                        <option value="APV" {% if filter_value == 'APV' %}selected{% endif %}>{% translate "APV" %}</option>
                    </select>

                    <select name="filter_value" id="availability-input" class="form-select" style="display:none;">
                        <option value="yes" {% if filter_value == 'yes' %}selected{% endif %}>{% translate "Available" %}</option>
                        <option value="no" {% if filter_value == 'no' %}selected{% endif %}>{% translate "Not Available" %}</option>
                    </select>

                    <select name="filter_value" id="status-input" class="form-select" style="display:none;">
                        <option value="True" {% if filter_value == 'True' %}selected{% endif %}>{% translate "Active" %}</option>
                        <option value="False" {% if filter_value == 'False' %}selected{% endif %}>{% translate "Not Active" %}</option>
                    </select>
                </div>

                <div class="col-md-3 d-grid d-md-flex gap-2">
                    <button type="submit" class="btn btn-primary w-100">{% translate "Filter" %}</button>
                    <a href="{% url 'booking_app:admin_vehicle_list' %}" class="btn btn-secondary w-100">{% translate "Clear" %}</a>
                </div>
            </div>
        </form>

        {% if vehicles %}
            <div class="table-responsive">
                <table class="table table-striped table-hover align-middle">
                    <thead class="table-dark">
                        <tr>
                            <th>{% translate "Picture" %}</th>
                            <th>{% translate "License Plate" %}</th>
                            <th>{% translate "Model" %}</th>
                            <th>{% translate "Type" %}</th>
                            <th>{% translate "Available" %}</th>
                            <th>{% translate "Booked By (Customer)" %}</th>
                            <th>{% translate "Location" %}</th>
                            <th>{% translate "Active" %}</th>
                            <th>{% translate "Actions" %}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for vehicle in vehicles %}
                        <tr>
                            <td>
                                {% if vehicle.picture %}
                                    <img src="{{ vehicle.picture.url }}" alt="{{ vehicle.license_plate }}" class="img-thumbnail" style="width: 80px; height: auto;">
                                {% else %}
                                    <img src="{% static 'Default/no_image.png' %}" alt="No Image" class="img-thumbnail" style="width: 80px; height: auto;">
                                {% endif %}
                            </td>
                            <td>{{ vehicle.license_plate }}</td>
                            <td>{{ vehicle.model }}</td>
                            <td>{{ vehicle.get_vehicle_type_display }}</td>
                            <td>
                                {% if vehicle.is_available_now %}
                                    <span class="badge bg-success">{% translate "Yes" %}</span>
                                {% elif vehicle.next_available_start %}
                                    <span class="badge bg-info text-dark">
                                        {% translate "Next" %}: {{ vehicle.next_available_start|date:"d/m/Y" }}
                                    </span>
                                {% else %}
                                    <span class="badge bg-danger">{% translate "No" %}</span>
                                {% endif %}
                            </td>
                            <td>{{ vehicle.current_customer|default:"N/A" }}</td>
                            <td>{{ vehicle.current_location.name|default:"N/A" }}</td>
                            <td>
                                {% if vehicle.is_active %}
                                    <span class="badge bg-success">{% translate "Yes" %}</span>
                                {% else %}
                                    <span class="badge bg-danger">{% translate "No" %}</span>
                                {% endif %}
                            </td>
                            <td class="text-end text-nowrap">
                                <a href="{% url 'booking_app:admin_vehicle_detail' pk=vehicle.pk %}" class="btn btn-info btn-sm">{% translate "Details" %}</a>
                                <a href="{% url 'booking_app:admin_vehicle_edit' pk=vehicle.pk %}" class="btn btn-secondary btn-sm">{% translate "Edit" %}</a>
                                <a href="{% url 'booking_app:admin_vehicle_inactive' pk=vehicle.pk %}" class="btn btn-danger btn-sm">{% translate "Deactivate" %}</a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <nav aria-label="Vehicle list navigation">
                <ul class="pagination justify-content-center">
                    {% if vehicles.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?page=1&sort={{ current_sort }}&dir={{ current_dir }}">&laquo; {% translate "first" %}</a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ vehicles.previous_page_number }}&sort={{ current_sort }}&dir={{ current_dir }}">{% translate "previous" %}</a>
                        </li>
                    {% else %}
                        <li class="page-item disabled"><span class="page-link">&laquo; {% translate "first" %}</span></li>
                        <li class="page-item disabled"><span class="page-link">{% translate "previous" %}</span></li>
                    {% endif %}

                    <li class="page-item active">
                        <span class="page-link">{% translate "Page" %} {{ vehicles.number }} {% translate "of" %} {{ vehicles.paginator.num_pages }}</span>
                    </li>

                    {% if vehicles.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ vehicles.next_page_number }}&sort={{ current_sort }}&dir={{ current_dir }}">{% translate "next" %}</a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ vehicles.paginator.num_pages }}&sort={{ current_sort }}&dir={{ current_dir }}">{% translate "last" %} &raquo;</a>
                        </li>
                    {% else %}
                        <li class="page-item disabled"><span class="page-link">{% translate "next" %}</span></li>
                        <li class="page-item disabled"><span class="page-link">{% translate "last" %} &raquo;</span></li>
                    {% endif %}
                </ul>
            </nav>
        {% else %}
            <div class="alert alert-info" role="alert">
                {% translate "No vehicles found matching your criteria." %}
            </div>
        {% endif %}
    </div>

    <div class="card-footer py-2 d-flex justify-content-end">
        <a href="{% url 'booking_app:admin_dashboard' %}" class="btn btn-secondary btn-sm text-nowrap">
            {% translate "Back to Admin Dashboard" %}
        </a>
    </div>
</div>

<div class="modal fade" id="importModal" tabindex="-1" aria-labelledby="importModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" action="{% url 'booking_app:import_vehicles' %}" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title" id="importModalLabel">{% translate "Import Vehicles from CSV" %}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="csv_file" class="form-label">{% translate "Choose CSV File" %}</label>
                        <input type="file" name="csv_file" id="csv_file" class="form-control" required accept=".csv">
                        <div class="form-text text-muted">
                            {% translate "File must be a CSV with headers like 'license_plate', 'model', etc." %}
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% translate "Close" %}</button>
                    <button type="submit" class="btn btn-primary">{% translate "Upload & Import" %}</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const filterBySelect = document.getElementById('filter_by');
    const textInput = document.getElementById('text-input');
    const typeInput = document.getElementById('type-input');
    const availabilityInput = document.getElementById('availability-input');
    const statusInput = document.getElementById('status-input');

    // Only clear inputs on first load if they have default values
    if (!textInput.value) textInput.value = '';

    function toggleInputs() {
        textInput.style.display = 'none';
        textInput.disabled = true;

        typeInput.style.display = 'none';
        typeInput.disabled = true;

        availabilityInput.style.display = 'none';
        availabilityInput.disabled = true;

        statusInput.style.display = 'none';
        statusInput.disabled = true;

        const selected = filterBySelect.value;
        if (selected === 'vehicle_type') {
            typeInput.style.display = 'block';
            typeInput.disabled = false;
        } else if (selected === 'annotated_is_available') {
            availabilityInput.style.display = 'block';
            availabilityInput.disabled = false;
        } else if (selected === 'active_status') {
            statusInput.style.display = 'block';
            statusInput.disabled = false;
        } else {
            textInput.style.display = 'block';
            textInput.disabled = false;
        }
    }

    filterBySelect.addEventListener('change', toggleInputs);
    toggleInputs();  // initial run
});
</script>
{% endblock content %}